<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EsferaZap MVP - Interface de Teste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-green-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-purple-600 bg-clip-text text-transparent">
                        ðŸš€ EsferaZap MVP Test Interface
                    </h1>
                    <p class="text-gray-600 mt-2">Teste todas as funcionalidades do WhatsApp SaaS</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Project ID</div>
                    <div class="font-mono text-sm">silent-text-458716-c9</div>
                    <div id="status" class="mt-2">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">
                            <i class="fas fa-circle text-yellow-500 animate-pulse"></i> Connecting...
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid md:grid-cols-2 gap-8">

            <!-- WhatsApp Connection -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fab fa-whatsapp text-green-500"></i> WhatsApp Connection
                </h2>

                <div class="space-y-4">
                    <div id="qrcode" class="bg-gray-100 rounded-lg p-8 text-center">
                        <div class="text-gray-500">
                            <i class="fas fa-qrcode text-6xl mb-4"></i>
                            <p>QR Code will appear here</p>
                        </div>
                    </div>

                    <button onclick="connectWhatsApp()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition">
                        <i class="fas fa-link"></i> Connect WhatsApp
                    </button>

                    <div class="flex gap-2">
                        <button onclick="testMessage()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition">
                            <i class="fas fa-paper-plane"></i> Test Message
                        </button>
                        <button onclick="disconnect()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition">
                            <i class="fas fa-unlink"></i> Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Agent Test -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-robot text-purple-500"></i> AI Agent (Google ADK)
                </h2>

                <div class="space-y-4">
                    <select id="agentType" class="w-full p-3 border rounded-lg">
                        <option value="customer-service">Customer Service Agent</option>
                        <option value="sales">Sales Agent</option>
                        <option value="technical">Technical Support Agent</option>
                        <option value="custom">Custom ADK Agent</option>
                    </select>

                    <textarea id="agentPrompt" class="w-full p-3 border rounded-lg" rows="4"
                        placeholder="Enter your message to test the AI agent..."></textarea>

                    <button onclick="testAgent()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-lg transition">
                        <i class="fas fa-brain"></i> Test AI Agent
                    </button>

                    <div id="agentResponse" class="bg-gray-50 rounded-lg p-4 min-h-[100px]">
                        <div class="text-gray-400 text-sm">Agent response will appear here...</div>
                    </div>
                </div>
            </div>

            <!-- API Endpoints Test -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-code text-blue-500"></i> API Endpoints
                </h2>

                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-mono">/api/health</span>
                        <button onclick="testEndpoint('/api/health')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                            Test
                        </button>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-mono">/api/messages/send</span>
                        <button onclick="testEndpoint('/api/messages/send')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                            Test
                        </button>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-mono">/api/contacts</span>
                        <button onclick="testEndpoint('/api/contacts')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                            Test
                        </button>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-mono">/api/webhooks</span>
                        <button onclick="testEndpoint('/api/webhooks')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                            Test
                        </button>
                    </div>
                </div>

                <div id="apiResponse" class="mt-4 p-3 bg-gray-900 text-green-400 rounded-lg font-mono text-xs overflow-x-auto">
                    <div>// API responses will appear here</div>
                </div>
            </div>

            <!-- Cloud Run Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-cloud text-sky-500"></i> Cloud Run Status
                </h2>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Service</span>
                        <span class="font-mono text-sm">esferazap-mvp</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Region</span>
                        <span class="font-mono text-sm">us-central1</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">URL</span>
                        <span id="serviceUrl" class="text-xs text-blue-500 truncate max-w-[200px]">
                            Checking...
                        </span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="serviceStatus" class="px-2 py-1 bg-gray-100 rounded text-xs">
                            <i class="fas fa-spinner fa-spin"></i> Checking
                        </span>
                    </div>

                    <button onclick="checkCloudRun()" class="w-full bg-sky-500 hover:bg-sky-600 text-white py-2 rounded-lg transition mt-4">
                        <i class="fas fa-sync-alt"></i> Refresh Status
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs Console -->
        <div class="bg-gray-900 rounded-xl shadow-lg p-6 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-white font-semibold">
                    <i class="fas fa-terminal"></i> Console Logs
                </h2>
                <button onclick="clearLogs()" class="text-gray-400 hover:text-white text-sm">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            <div id="console" class="bg-black rounded-lg p-4 h-48 overflow-y-auto font-mono text-xs text-green-400">
                <div>[System] Interface initialized...</div>
            </div>
        </div>
    </div>

    <script>
        // Base configuration
        const CONFIG = {
            cloudRunUrl: 'https://esferazap-mvp-xxxxx-uc.a.run.app',
            localUrl: 'http://localhost:5000',
            projectId: 'silent-text-458716-c9'
        };

        let useLocal = true; // Start with local for testing

        // Logging function
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                success: 'text-blue-400'
            };

            const entry = document.createElement('div');
            entry.className = colors[type] || 'text-green-400';
            entry.textContent = `[${time}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('console').innerHTML = '<div>[System] Console cleared</div>';
        }

        // Get API URL
        function getApiUrl() {
            return useLocal ? CONFIG.localUrl : CONFIG.cloudRunUrl;
        }

        // Connect WhatsApp
        async function connectWhatsApp() {
            log('Connecting to WhatsApp...', 'info');
            try {
                const response = await fetch(`${getApiUrl()}/api/whatsapp/qr`);
                const data = await response.json();

                if (data.qr) {
                    document.getElementById('qrcode').innerHTML = `
                        <img src="${data.qr}" alt="QR Code" class="mx-auto">
                        <p class="text-sm text-gray-600 mt-2">Scan with WhatsApp</p>
                    `;
                    log('QR Code generated successfully', 'success');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Test message
        async function testMessage() {
            log('Sending test message...', 'info');
            try {
                const response = await fetch(`${getApiUrl()}/api/messages/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        to: '5511999999999',
                        message: 'Test message from EsferaZap MVP!'
                    })
                });
                const data = await response.json();
                log('Message sent successfully', 'success');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Disconnect
        function disconnect() {
            log('Disconnecting WhatsApp...', 'warning');
            document.getElementById('qrcode').innerHTML = `
                <div class="text-gray-500">
                    <i class="fas fa-qrcode text-6xl mb-4"></i>
                    <p>Disconnected</p>
                </div>
            `;
        }

        // Test AI Agent
        async function testAgent() {
            const agentType = document.getElementById('agentType').value;
            const prompt = document.getElementById('agentPrompt').value;

            log(`Testing ${agentType} agent...`, 'info');
            document.getElementById('agentResponse').innerHTML = '<div class="text-gray-400"><i class="fas fa-spinner fa-spin"></i> Processing...</div>';

            try {
                const response = await fetch(`${getApiUrl()}/api/agent/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: agentType,
                        message: prompt
                    })
                });
                const data = await response.json();

                document.getElementById('agentResponse').innerHTML = `
                    <div class="text-sm text-gray-700">${data.response || 'Agent response received'}</div>
                `;
                log('Agent responded successfully', 'success');
            } catch (error) {
                document.getElementById('agentResponse').innerHTML = `
                    <div class="text-red-500 text-sm">Error: ${error.message}</div>
                `;
                log(`Agent error: ${error.message}`, 'error');
            }
        }

        // Test endpoint
        async function testEndpoint(endpoint) {
            log(`Testing ${endpoint}...`, 'info');
            try {
                const response = await fetch(`${getApiUrl()}${endpoint}`);
                const data = await response.json();

                document.getElementById('apiResponse').innerHTML = JSON.stringify(data, null, 2);
                log(`${endpoint} responded with status ${response.status}`, 'success');
            } catch (error) {
                document.getElementById('apiResponse').innerHTML = `// Error: ${error.message}`;
                log(`${endpoint} error: ${error.message}`, 'error');
            }
        }

        // Check Cloud Run status
        async function checkCloudRun() {
            log('Checking Cloud Run status...', 'info');
            const statusEl = document.getElementById('serviceStatus');
            const urlEl = document.getElementById('serviceUrl');

            try {
                const response = await fetch(`${CONFIG.cloudRunUrl}/health`);
                if (response.ok) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> Running';
                    statusEl.className = 'px-2 py-1 bg-green-100 text-green-800 rounded text-xs';
                    urlEl.textContent = CONFIG.cloudRunUrl;
                    useLocal = false;
                    log('Cloud Run service is running', 'success');
                } else {
                    throw new Error('Service not responding');
                }
            } catch (error) {
                statusEl.innerHTML = '<i class="fas fa-times-circle text-red-500"></i> Not deployed';
                statusEl.className = 'px-2 py-1 bg-red-100 text-red-800 rounded text-xs';
                urlEl.textContent = 'Using local server';
                useLocal = true;
                log('Cloud Run not available, using local', 'warning');
            }
        }

        // Initialize on load
        window.onload = () => {
            log('Testing interface loaded', 'success');
            checkCloudRun();

            // Update connection status
            setTimeout(() => {
                document.getElementById('status').innerHTML = `
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                        <i class="fas fa-circle text-green-500"></i> Ready
                    </span>
                `;
            }, 1000);
        };
    </script>
</body>
</html>